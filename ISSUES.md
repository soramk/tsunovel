# プロジェクトの問題管理 (Issues)

## [Closed] モバイルブラウザでバックグラウンド復帰時にホームに戻り、背景再読み込みが発生する

**問題内容:**
モバイルにてブラウザをバックグラウンドにしておくと、タブ破棄により再読み込みが発生し、ホーム画面に戻される場合がある。またその際、背景画像の読み込みが走り、ファイル容量が大きいため出先での通信負担や表示遅延の原因となっている。

**原因:**

1. 画面状態（現在のビュー、閲覧中の小説・話数）がURLや永続ストレージによって完全に管理・復元されていないため、リロードで初期状態（ホーム）に戻る。
2. PWA化やService Workerによるキャッシュ制御が行われておらず、ブラウザの標準キャッシュ挙動に依存している。大容量画像がメモリから破棄されやすい。

**対応内容:**

1. `vite-plugin-pwa` を導入し、PWA設定を追加。Service Workerにより `public/pict/` 内の画像やフォントをキャッシュする設定を行った。
2. アプリケーションの表示状態（ViewMode, NovelId, ChapterNum等）を `localStorage` に保存し、初期化時に復元するロジックを `App.jsx` に追加した。

**ステータス:** 完了 (2026-01-24)

---

## [Closed] IndexedDB使用時にリロードするとダウンロード進捗が0%になる

**問題内容:**
オフラインストレージをIndexedDBに設定している際、ダウンロード中に進捗が表示されるが、ページをリロードすると進捗が0%に戻ってしまう。localStorageでは正常に表示されるため、IndexedDB使用時の進捗状況読み取り機能に不備があると思われる。

**原因:**

1. `getDownloadStatus` 関数が同期関数であり、`localStorage` の値を直接見に行っていたため、IndexedDBに保存されたデータを検知できなかった。
2. リロード時に `downloadStatuses` キャッシュがクリアされるが、IndexedDBの非同期読み込みが完了する前に表示が行われ、フォールバックで0%（localStorageチェックの結果）が表示されていた。
3. 全チャプターの存在チェックを1つずつ `chapterExists` で行っていたため、特に IndexedDB ではオーバーヘッドが大きく、表示の更新が遅れていた。

**対応内容:**

1. `src/utils/offlineStorage.js` に `getDownloadedChapterNumbers` 関数を追加。IndexedDBのインデックスを活用して、ダウンロード済みのチャプター番号を一括で高速に取得できるようにした。
2. `src/App.jsx` の `updateDownloadStatusCache` を改善し、上記の一括取得関数を利用することで進捗更新のパフォーマンスを向上させた。
3. `getDownloadStatus` を修正し、現在のストレージ設定（IndexedDB/localStorage）を考慮するように変更。また、キャッシュがない場合に自動的に非同期でのステータス更新をスケジュールするようにした。

**ステータス:** 完了 (2026-01-18)

---

## [Closed] ライブラリ画面（トップ）でリロード後にオフラインダウンロード状況が表示されない

**問題内容:**
ライブラリ画面で作品を選択するとオフラインダウンロード状況（アイコン・インジケーター）が表示されるが、ページをリロードするとすべて表示されなくなる。

**原因:**

1. 小説リストは `index.json` からロードされるが、この時点では `general_all_no`（総話数）が含まれていない。
2. 総話数がないとダウンロード進捗（X話/全Y話）を計算できないため、進捗が0%のままになっていた。
3. 各小説の詳細情報（`info.json`）は「作品を選択したとき」にしか読み込まれず、ライブラリ一覧表示時には読み込まれていなかった。

**対応内容:**
`refreshAllDownloadStatuses` 関数を改善し、各小説の `info.general_all_no` が未取得の場合は先に `info.json` を取得してから進捗計算を行うように修正した。これにより、リロード直後も各作品のオフラインダウンロード状況が正しく表示されるようになった。

**ステータス:** 完了 (2026-01-18)

---

## [Closed] モバイルでのリーダー操作時の画面の浮きと拡大・縮小の防止

**問題内容:**
モバイルでリーダーを利用していると、指の操作に反応して画面がふわふわと浮いてしまう（オーバースクロール）。また、ピンチ操作などにより意図せず画面が拡大・縮小されてしまう。

**原因:**

1. ブラウザ標準のオーバースクロール挙動（ラバーバンド効果）が有効になっている。
2. マルチタッチによるズーム操作やダブルタップズームが制限されていない。

**対応内容:**

1. `index.css` の `body` に `overscroll-behavior-y: none` を追加し、モバイルでのバウンス（オーバースクロール）効果を無効化。
2. `index.css` に `.no-zoom` クラス (`touch-action: pan-y`) を追加し、リーダー画面でのピンチズームやダブルタップズームを防止（垂直スクロールは維持）。
3. `App.jsx` のリーダーコンテナに `.no-zoom` クラスを適用。
4. `index.html` の `viewport` 設定に `maximum-scale=1.0, user-scalable=no` を追記。

**ステータス:** 完了 (2026-01-27)

---

## [Closed] モバイルで時間経過後のページ遷移時にフリーズする

**問題内容:**
モバイルでリーダーを利用しているとき、しばらく時間が経過した後に次のページを表示させようとすると、読み込み中のまま固まってしまうことがある。

**原因:**

1. GitHub API への fetch リクエストにタイムアウトが設定されていなかった。
2. モバイルでバックグラウンドから復帰した際、ネットワーク接続が不安定になり、fetch リクエストが無限に待機状態になっていた。
3. ローディング状態がリセットされないため、ユーザーは状況を把握できず、キャンセルする手段もなかった。

**対応内容:**

1. `fetchWithTimeout` ヘルパー関数を追加し、全ての fetch リクエストに10〜15秒のタイムアウトを設定。
2. 対象ファイル:
   - `src/App.jsx`: `loadChapter` 関数と `predownloadNovel` 関数内の fetch 呼び出しにタイムアウトを追加
   - `src/utils/githubActions.js`: 全ての fetch 呼び出しにタイムアウトを追加
   - `src/utils/novelFetcher.js`: `fetchSyosetuNovel` 関数の fetch 呼び出しにタイムアウトを追加
3. タイムアウト時は `AbortController` を使用してリクエストを中断し、エラーとして処理される。

**ステータス:** 完了 (2026-02-02)
